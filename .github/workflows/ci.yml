name: Akeneo CE CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  php_checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP with Composer cache
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, pdo_mysql
          coverage: none
          tools: composer
          cache: composer
          ini-values: memory_limit=1G

      - name: Validate composer files
        run: composer validate --no-check-all

      - name: Install PHP dependencies
        run: composer install --no-interaction --prefer-dist --no-progress

      - name: PHP lint (src + config)
        run: |
          find src config -type f -name "*.php" -print0 | xargs -0 -n 10 php -l

  security_audit:
    runs-on: ubuntu-latest
    needs: php_checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP with Composer cache
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer
          cache: composer
          ini-values: memory_limit=1G

      - name: Install PHP dependencies (no dev)
        run: composer install --no-interaction --prefer-dist --no-progress --no-dev

      - name: Composer security audit (allowed to fail)
        run: composer audit --format plain
        continue-on-error: true
